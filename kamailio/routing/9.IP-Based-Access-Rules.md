# IP Based Access Rules (Règles d'accès basées sur l'IP)

Dans de nombreux déploiements, l'instance de serveur SIP doit être interconnectée avec d'autres nœuds du réseau ou avec d'autres fournisseurs de services SIP. Il peut s'agir d'un serveur de média de transcodage, d'un proxy de périphérie, d'un fournisseur d'origine et de terminaison RTC ou d'un partenaire de peering amical.
Dans ces cas, les appels d'authentification par nom d'utilisateur et mot de passe sont la plupart du temps impossibles. La solution réside dans des relations IP de confiance. Chaque nœud SIP utilise une IP statique (ou se trouve dans un sous-réseau spécifique) qui est conservée dans une liste d'adresses de confiance. Lorsque les demandes SIP proviennent de ces adresses, elles sont autorisées sans être contestées pour l'authentification.
L'inverse pourrait également être utile, en bloquant le trafic provenant d'adresses IP spécifiques (par exemple, source d'attaques identifiée).

 
Il existe plusieurs options disponibles dans Kamailio pour tester les adresses sources des paquets SIP : 
* conditions statiques dans le fichier de configuration
* Module **ipops** pour une plus grande flexibilité dans la comparaison avec IPv6
* module d'autorisation pour la correspondance des adresses **IP** et des **sous-réseaux**
* des **fonctions spécifiques** dans plusieurs des modules de routage **SIP**


## STATIC RULES IN CONFIGURATION FILE (RÈGLES STATIQUES DANS LE FICHIER DE CONFIGURATION)


L'interpréteur exporte plusieurs mots clés relatifs aux adresses IP associées aux requêtes SIP, ils sont énumérés dans le chapitre "Éléments du fichier de configuration". Les plus importants en relation avec l'adresse source des paquets sont
* **src_ip** - l'adresse IP à partir de laquelle le paquet SIP a été envoyé
* **src_port** - le port à partir duquel le paquet SIP a été envoyé
* **proto** - la couche de transport utilisée pour envoyer le paquet SIP (UDP, TCP, TLS ou SCTP) 
* **af** - famille d'adresses pour le protocole IP utilisé pour envoyer le paquet SIP (IPv4 ou IPv6)
Lorsqu'il s'agit d'une petite liste de pairs de confiance, peu susceptible de changer, la solution rapide consiste à ajouter des conditions dans le fichier de configuration.

Par exemple, si tout le trafic passe par un proxy périphérique situé au point 1.2.3.4, le serveur SIP principal peut avoir le bloc IF suivant juste au début du bloc request_route :

    if(src_ip!=1.2.3.4) { 
      sl_send_reply(“404”, “Forbidden”); 
      exit;
    }

Pour supprimer également les réponses SIP qui ne proviennent pas de la version 1.2.3.4, vous pouvez ajouter dans la configuration le bloc **reply_route** suivant :

    reply_route { 
      if(src_ip!=1.2.3.4)
        drop; 
    }
L'ajout de restrictions sur le port et le protocole peut être facilement effectué en utilisant les opérateurs logiques ET dans la condition FI, par exemple, en refusant le trafic s'il ne passe pas par l'UDP à partir du point 1.2.3.4 et du port 5060 :

    if( ! (src_ip==1.2.3.4 && src_port=5060 && proto==UDP) ) {
        sl_send_reply(“404”, “Forbidden”);
        exit;
    }
    
Notez les opérateurs de négation dans l'expression IF et l'opérateur égal au lieu de différent lors de la comparaison de l'IP source.
 
Le mot-clé src_ip peut être testé par rapport à une adresse de sous-réseau. Une adresse de réseau est représentée par le masque de bits slash de l'adresse IP (longueur ou masque de réseau). Le test pour savoir si les paquets proviennent de la version 1.2.3.0/24 peut être effectué de la même manière :

    if(src_ip!=1.2.3.0/24) { 
        sl_send_reply(“404”, “Forbidden”); 
        exit;
    }
    
ou
    
    if(src_ip!=1.2.3.0/255.255.255.0) { 
        sl_send_reply(“404”, “Forbidden”); 
        exit;
    }
    

Certains de ces mots clés ont un équivalent dans les pseudo-variables : 
* **src_ip** est **$si**
* **src_port** est **$sp**
* **proto** est **$pr** (ou **$proto**)
    
