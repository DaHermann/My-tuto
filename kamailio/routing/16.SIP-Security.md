# SIP Security (Sécurité SIP)



La sécurité des serveurs fonctionnant sur l'internet public est un travail d'une journée entière, qui nécessite de se tenir au courant des rapports de sécurité de nombreuses applications, y compris le noyau OS/Linux. Les serveurs VoIP sont une cible attrayante car y accéder peut apporter des avantages financiers importants pour les attaquants si le service achemine les appels vers le RTPC (PSTN).


## PRELIMINARY REMARKS (OBSERVATIONS PRÉLIMINAIRES)



Sachant que Kamailio est plus ou moins un cadre pour la construction de serveurs de signalisation SIP avec un ensemble particulier de fonctions, il est bon de résumer certains des aspects de conception qui doivent être pris en considération pour la sécurité :
- Les requêtes SIP ne sont pas transmises à moins qu'il n'y ait une action explicite (t_relay(), forward() ou autre) dans le fichier de configuration. Les demandes peuvent créer des sessions et il peut y avoir des coûts, faites attention si l'appelant est autorisé à initier une telle session avant de transférer.
- Les réponses SIP sont automatiquement transférées s'il n'y a pas d'action d'abandon dans le bloc de routage du traitement des réponses. Une réponse SIP ne peut pas être authentifiée, mais elle ne peut pas non plus initier une session, ce qui n'entraîne pas de coût direct pour la session. Cependant, comme toute donnée sur le fil, elle peut remplir la bande passante et, même s'il s'agit d'un traitement très léger, elle peut ajouter à la consommation de ressources CPU/mémoire. Vous pouvez utiliser t_check_trans() pour vous assurer qu'il y a une transaction associée à chaque réponse reçue par Kamailio
- le projet Kamailio fournit un kamailio.cfg par défaut, sans lui, Kamailio ne devrait pas démarrer. Vous devez examiner attentivement le fichier de configuration et activer les fonctionnalités appropriées pour qu'il fonctionne en toute sécurité selon vos besoins



## SECURITY IN DEFAULT KAMAILIO.CFG (SÉCURITÉ PAR DÉFAUT KAMAILIO.CFG)


Default kamailio.cfg essaie d'être un bon point de départ pour construire des services plus avancés. il comprend des fonctionnalités pour l'acheminement des appels entre les utilisateurs locaux ainsi que l'acheminement des appels vers une passerelle **RTC**. Cependant, l'adresse de la passerelle n'est pas spécifiée (étant particulière à chaque installation), ce qui signifie qu'elle n'achemine rien à moins que kamailio.cfg ne soit mis à jour et que l'adresse de la passerelle y soit définie.
De plus, l'authentification des utilisateurs n'est pas activée avec le fichier kamailio.cfg. Elle doit être activée en définissant **WITH_AUTH**. Au préalable, la table de la base de données doit être créée et les profils d'utilisateurs doivent être ajoutés à la table des abonnés.
L'authentification est construite autour du concept d'utilisateurs locaux. Un serveur SIP considère comme utilisateurs locaux ceux qui ont un domaine From avec une adresse IP ou des noms d'hôtes associés au système. Une fois l'authentification activée, Kamailio met au défi tous les utilisateurs locaux de fournir des justificatifs d'identité.
Que l'authentification soit activée ou non, l'acheminement des flux entrants et sortants suit les règles :
- un utilisateur local peut appeler n'importe où : vers d'autres utilisateurs locaux, vers des utilisateurs étrangers (sur d'autres réseaux VoIP) ou vers le **RTPC (PSTN)**
- un utilisateur étranger ne peut appeler qu'un utilisateur local - il n'est pas autorisé à appeler un autre utilisateur étranger (pas un relais ouvert) et n'est pas autorisé à appeler le **RTPC** (n'étant pas local, il ne peut pas être facturé)
En termes d'autorisation, le site par défaut kamailio.cfg peut autoriser le trafic sans authentification de l'utilisateur à condition que l'adresse IP de l'expéditeur soit inscrite sur une liste blanche - son adresse est stockée dans la table de base de données "address" avec l'identifiant de groupe 1. Revoyez les chapitres sur l'authentification des utilisateurs et l'autorisation IP pour renforcer ou assouplir davantage ces règles.
Pour détecter et bloquer les attaques malveillantes, stock kamailio.cfg offre la possibilité d'activer le suivi du nombre de demandes par intervalle de temps envoyées depuis une IP spécifique et de déclencher une alerte lorsqu'une limite est dépassée (16 demandes en 2 secondes), en écartant le trafic de cette adresse pendant cinq minutes. La détection se fait avec le module pike et la liste des adresses bloquées est conservée dans une table de hachage du module htable.
Pour activer cette fonctionnalité, ajoutez #!define WITH_ANTIFLOOD dans le fichier de configuration. Les extraits pertinents du fichier de configuration sont les suivants :
      
          ...
          71. # *** To enable anti-flood detection execute:
          72. # - adjust pike and htable=>ipban settings as needed (default is
          73. # block if more than 16 requests in 2 seconds and ban for 300 seconds) 74. # !define WITH_ANTIFLOOD
          ...
          274. #!ifdef WITH_ANTIFLOOD
          275. loadmodule "htable.so"
          276. loadmodule "pike.so"
          277. #!endif
          ...
          428. #!ifdef WITH_ANTIFLOOD
          429. # ----- pike params -----
          430. modparam("pike", "sampling_time_unit", 2)
          431. modparam("pike", "reqs_density_per_unit", 16)
          432. modparam("pike", "remove_latency", 4)
          433.
          434. # ----- htable params -----
          435. # ip ban htable with autoexpire after 5 minutes
          436. modparam("htable", "htable", "ipban=>size=8;autoexpire=300;")
          437. #!endif
          ...
          545. route[REQINIT] {
          546. #!ifdef WITH_ANTIFLOOD
          547. # flood dection from same IP and traffic ban for a while                       
          548. # be sure you exclude checking trusted peers, such as pstn gateways 
          549. # - local host excluded (e.g., loop to self)
          550. if(src_ip!=myself) {
          551.   if($sht(ipban=>$si)!=$null) {
          552.     # ip is already blocked
          553.     xdbg("request from blocked IP - $rm from $fu (IP:$si:$sp)\n"); 
          554.     exit;
          555.   }
          556.   if (!pike_check_req()) {
          557.     xlog("L_ALERT","ALERT: pike blocking $rm from $fu (IP:$si:$sp)\n"); 
          558.     $sht(ipban=>$si) = 1;
          559.     exit;
          560.   } 
          561. }
          562. if($ua =~ "friendly-scanner") { 
          563.  sl_send_reply("200", "OK"); 
          564.  exit;
          565. } 
          566. #!endif
          ...

