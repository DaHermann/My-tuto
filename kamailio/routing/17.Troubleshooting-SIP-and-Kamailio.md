# Troubleshooting SIP and Kamailio


L'objectif de ce chapitre est de présenter plusieurs outils et mécanismes qui peuvent aider à dépanner le fichier de configuration Kamailio et le routage SIP.


## CAPTURING SIP TRAFFIC (CAPTER LE TRAFIC DES SIP)


La possibilité de corréler les messages du journal avec le trafic SIP est, dans la plupart des cas, très utile. Bien qu'ils ne soient pas présentés de manière exhaustive, voici des détails sur plusieurs outils et commandes qui peuvent être utilisés pour capturer le trafic réseau, dont certains sont adaptés aux paquets SIP.
La liste a sélectionné ceux qui sont disponibles gratuitement et étant open source, il y en a beaucoup avec une licence commerciale, une recherche sur le web devrait facilement les révéler.
La plupart d'entre eux, sinon tous, acceptent la syntaxe du filtre de paquets de Berkeley (BPF) pour faire correspondre le trafic réseau à la capture :

• http://en.wikipedia.org/wiki/Berkeley_Packet_Filter 
• http://biot.com/capstats/bpf.html


### NGREP

Outil assez ancien et petit, packagé par la plupart des distributions Linux et BSD bien connues, ngrep est un outil en ligne de commande adapté à la capture et à la visualisation en temps réel du trafic réseau formaté en texte brut. Il est particulièrement utile pour travailler à distance via ssh.
Le site web du projet est :

• http://ngrep.sourceforge.net

Outre la possibilité d'imprimer immédiatement sur le terminal, ngrep peut écrire les paquets capturés dans un fichier pcap. S'il est capturé sur un serveur distant, le fichier pcap peut être téléchargé et analysé avec d'autres outils. Les filtres peuvent être effectués sur les attributs d'adresse (tels que le port source ou de destination, le protocole de transport ou l'adresse IP) et sur les expressions régulières correspondantes du contenu du paquet.
Quelques commandes utiles pour examiner le trafic SIP :

  - tout capturer sur le port 5060

        ngrep -d any -qt -W byline “.*” port 5060
      
  - capture des paquets sur le port 5060 qui ont le mot "sip" - cela peut être utile si vous avez des keepalives NAT UDP (généralement 4 octets apparaissant périodiquement)
  
  
        ngrep -d any -qt -W byline “sip” port 5060

- ne saisir que les paquets SIP qui sont destinés aux enregistrements - saisir à la fois les demandes et les réponses  
  
        ngrep -d any -qt -W byline “CSeq: [0-9]+ REGISTER” port 5060
  
  
 - saisir uniquement les demandes SIP INVITE 
  
        ngrep -d any -qt -W byline “^INVITE sip” port 5060
  
 - saisir les demandes et les réponses du SIP INVITE
  
        ngrep -d any -qt -W byline “CSeq: [0-9]+ INVITE” port 5060
        
  - capturer tous les paquets SIP qui pourraient faire partie d'un appel
  
        ngrep -d any -qt -W byline “CSeq: [0-9]+ (INVITE|ACK|CANCEL|BYE)” port 5060
  
  - capturer tous les paquets SIP dont l'en-tête ou le corps contient le mot "alice" de l'utilisateur
  
        ngrep -d any -qt -W byline “alice” port 5060
        
        
 - capturer tous les paquets SIP qui ont un alice utilisateur à l'intérieur de l'en-tête
 
        ngrep -d any -qt -W byline “From:.*sip:alice@” port 5060
        
- saisir tous les SIP provenant d'un IP particulier (par exemple, 1.2.3.4)


      ngrep -d any -qt -W byline “.*” host 1.2.3.4
      

- pour plus d'options, voir la page du manuel du ngrep

Notez que les commandes ci-dessus peuvent nécessiter des réglages dans divers cas, par exemple, certaines d'entre elles reposent sur la correspondance de l'en-tête From, mais cet en-tête peut avoir la forme abrégée "f". De plus, le schéma du protocole dans les URI SIP (par exemple, dans l'URI de l'en-tête From) peut être sip, sips, tel ou d'autres valeurs.
Le trafic SIP est généralement sur le port 5060, si vous utilisez Kamailio sur un autre port, vous devez ajuster la valeur dans les commandes ngrep. Ngrep peut filtrer sur plusieurs ports en même temps, vous pouvez utiliser une règle comme:

    ngrep -d any -qt -W byline “.*” port 5060 or port 5064 or port 5068
    

Sur différents systèmes, "-d any" ne fonctionne pas, le nom de l'interface doit être spécifié, par exemple "-d eth2".
Si vous souhaitez capturer le trafic envoyé depuis/vers un appareil spécifique enregistré, vous pouvez consulter l'emplacement de l'utilisateur et obtenir l'adresse IP de l'appareil reçu (si l'appareil est derrière NAT) ou l'adresse de contact :

    kamctl ul show alice
    ngrep -d any -qt -W byline “.*” host _ALICE_DEVICE_IP_
   

### WIRESHARK


C'est probablement l'outil graphique le plus connu pour l'analyse du trafic réseau. Il comprend certaines fonctionnalités dédiées à la VoIP, notamment la possibilité d'afficher un diagramme avec les flux de messages SIP ainsi que la relecture de l'audio de la capture réseau d'un appel VoIP.

Le site web du projet est :

• https://www.wireshark.org


Le projet Wireshare dispose de pages wiki dédiées aux appels VoIP et SIP, avec des informations utiles sur les
détails et références :

• http://wiki.wireshark.org/VoIP_calls
• http://wiki.wireshark.org/SIP


L'application est également fournie avec un outil en ligne de commande appelé tshark, pratique à utiliser dans les terminaux
sur ssh. Voici un exemple de son utilisation pour capturer le port 5060 sur l'interface eth0 :

    tshark -f "udp port 5060" -i eth0 -w /tmp/sip-capture.pcap

Le web offre un grand nombre de billets de blog et d'articles sur la façon d'utiliser wireshark pour la capture et le dépannage du trafic VoIP.


### TCPDUMP


Il est très probable que chaque système d'exploitation Linux/Unix possède déjà cet outil avec le système de base, sinon il devrait être disponible dans son dépôt.
La page web du projet est :

• http://www.tcpdump.org

En raison de sa large diffusion, il peut être possible d'obtenir les paquets SIP et RTP dans des situations extrêmes,
comme les appareils embarqués.
Le nombre de règles de filtrage est assez important, ce qui permet une grande souplesse dans le choix des éléments à filtrer. La documentation est disponible à l'adresse suivante:

• http://www.tcpdump.org/manpages/pcap-filter.7.html


Next are several useful commands:

- capture tout sur l'interface eth0 et le port 5060

    tcpdump -nq -s 0 -i eth0 -w /tmp/sip-capture.pcap port 5060
    
- saisir tout sur l'interface eth0 et le port 5060 ou le port 5064    
    
    
    tcpdump -nq -s 0 -i eth0 -w /tmp/sip-capture.pcap port 5060 or port 5064
    
- saisir tout sur l'interface eth0 et le port 5060, écrire un nouveau fichier toutes les heures, avec un nom de fichier formaté en utilisant la date et l'heure    
    
      tcpdump -nq -s 0 -i eth0 -G3600 -w /tmp/sipcapture—%F--%H-%M-%S.pcap port 5060

- pour mettre la commande précédente en arrière-plan et continuer à fonctionner lorsque le terminal est fermé, il peut être utilisé

      nohup tcpdump -nq -s 0 -i eth0 -G3600 -w /tmp/sipcapture—%F--%H-%M-%S.pcap port 5060 &
    

Les fichiers pcap enregistrés par tcpdump peuvent être analysés avec Wireshark.    
    
    
### SIPGREP

Un outil similaire au ngrep conçu pour l'interaction avec les paquets SIP. Il dispose de filtres dédiés à la correspondance sur les en-têtes SIP pertinents, tels que Contact, From ou To, et imprime une sortie colorée facilitant le repérage d'attributs spécifiques.
Il écoute par défaut sur les ports 5060 et 5061 (les ports standard pour SIP sur UDP/TCP/SCTP et TLS). Une autre fonctionnalité utile est la lecture des paquets SIP en suivant le temps delta d'un fichier de capture.
Le site web du projet est :

• https://github.com/sipcapture/sipgrep

Ensuite, il y a plusieurs commandes utiles :


  - capture des paquets SIP avec "alice" dans l'en-tête From
  
        sipgrep -f alice
        
  - capture des paquets SIP avec "alice" dans l'en-tête From et "bob" dans l'en-tête To     
  
        sipgrep -f alice -t bob
        
   - capturer les paquets SIP et les stocker dans des fichiers de taille 20MB (au nom du fichier sera
  joint le compteur de dossiers, la date et l'heure
  
        sipgrep -Q 'filesize:20' -O /tmp/sip-capture.pcap
        
### SNGREP  
  
  Bien qu'il soit relativement nouveau, cet outil peut être utile pour analyser le trafic SIP sur un terminal. Il construit des diagrammes avec le trafic entre les nœuds, donnant la possibilité de naviguer entre les paquets et de voir les détails de chaque message SIP.
La page web du projet est :

• https://github.com/irontec/sngrep


Sngrep peut être utilisé avec les règles BPF, les paquets sont capturés et les diagrammes sont mis à jour en temps réel. Les paquets appartenant au même dialogue SIP ou ayant le même Call-Id sont regroupés. Il peut écrire les paquets dans un fichier pcap ou lire les paquets d'un fichier pcap.
Voici quelques commandes utiles :
  - capturer les paquets SIP et afficher le diagramme du trafic sur le port 5060 ou le port 5062
  
        sngrep -d eth0 port 5060 or port 5062

 - capturer les paquets SIP correspondant à l'adresse 1.2.3.4 et au port 5060, les stocker dans un fichier pcap :
 
        sngrep -d eth0 -O /tmp/sip-capture.pcap host 1.2.3.4 and port 5060
 
 - charger à partir d'un fichier pcap les paquets correspondant à l'adresse 1.2.3.4
 
        sngrep -I /tmp/sip-capture.pcap host 1.2.3.4
 
 
 
 ### HOMER SIP CAPTURE
 
 Une suite d'outils permettant de construire une plateforme de capture et d'analyse SIP, particulièrement utile pour les grands déploiements de VoIP avec de nombreux nœuds SIP, mais très pratique pour les petits nœuds également. Les principaux composants sont les suivants :
- agent de capture - capture du trafic sur les interfaces du réseau local et mise en miroir vers le serveur de capture
- serveur de capture - réception du trafic en miroir des agents de capture, traitement du trafic à forte charge, agrégation et enregistrement dans la base de données
- interface web de capture - outils de gestion graphique pour l'analyse des paquets capturés Le site web du projet est :
- http://www.sipcapture.org
Kamailio lui-même peut être utilisé comme agent de capture (module siptrace) ou comme serveur de capture (sipcature
module).
L'interface web comporte des tonnes de fonctionnalités intéressantes, notamment des options de recherche avancée, l'affichage de diagrammes de flux d'appels, le regroupement de paquets sur des dialogues ou des call-id, des graphiques et des analyses statistiques, l'importation de fichiers pcap ou l'exportation de résultats de recherche sous forme de fichier pcap.
Des instructions complètes sur la façon de l'installer et de l'utiliser avec Kamailio sont disponibles sur le site web du projet.


## SIP COMMAND LINE TOOLS (OUTILS DE LA LIGNE DE COMMANDE SIP)
 
 Une liste avec plusieurs outils en ligne de commande qui peuvent être utilisés pour envoyer des paquets SIP depuis le terminal, très utile pour le dépannage dans de nombreux cas. Il n'entre pas dans le cadre de ce livre d'entrer dans les détails sur la façon d'utiliser l'un de ces outils.
 
 
 ### SIPSAK
 
 Acronyme de SIP Swiss Army Knife, il offre de nombreuses fonctionnalités pour générer des paquets SIP, comme la simulation d'enregistrements, l'envoi d'OPTIONS ou de requêtes INVITE, l'envoi du contenu d'un fichier.
 
 Homepage: https://github.com/nils-ohlmeier/sipsak
 
 ### SIPP
 
Très utile pour tester les performances ou les services. Il dispose d'un langage basé sur xml pour définir des scénarios SIP et les jouer.

Homepage: http://sipp.sourceforge.net


### PROTOSHOOT

Inclus dans l'arbre des sources de Kamailio, à utils/protoshoot - il s'agit d'une petite application utilitaire qui peut envoyer le contenu d'un fichier à une adresse donnée. Notez que cet outil n'est pas compilé ni installé par défaut, allez dans utils/protoshoot et lancez "make", puis copiez le binaire à l'emplacement souhaité.

Homepage: http://www.kamailio.org

### SIPGREP

Présenté dans la section précédente, peut être utilisé pour rejouer des fichiers pcap avec des paquets SIP.

Homepage: https://github.com/sipcapture/sipgrep

## LOG MESSAGES

Étant donné qu'il s'agit d'une application démon, le retour d'information sur ce qui est traité, les erreurs ou les notifications se fait principalement par le biais de messages de log. Dans un environnement de production, les journaux sont envoyés à syslog. Pour les tests ou le dépannage en direct, les journaux peuvent être écrits en erreur standard.


###  LOG MESSAGES OUTPUT TARGETS (LES OBJECTIFS DE SORTIE DES MESSAGES DU JOURNAL)


L'endroit où les journaux sont écrits peut être contrôlé via les paramètres de la ligne de commande ou le fichier de configuration Kamailio.
Pour récapituler les paramètres de ligne de commande liés à cette fonctionnalité :
 * -d : définit la verbosité de débogage, plusieurs "d" augmentent la verbosité, par exemple -ddd. Ceci contrôle la valeur du paramètre de débogage dans kamailio.cfg
 * -E : écrire des messages de journal sur le terminal d'erreur standard. S'ils ne sont pas utilisés, les messages de log sont écrits dans syslog
 * -e : activation des messages colorés du journal. Fonctionne lorsque -E est utilisé, les différents niveaux du journal seront imprimés avec des couleurs différentes
Par exemple, démarrer Kamailio avec debug=3 et imprimer des messages colorés en erreur standard :

      kamailio -ddd -E -e
      
 Par défaut, écrire dans syslog signifie simplement omettre le paramètre -E dans la ligne de commande.
Implicitement, Kamailio utilise le démon syslog. Cela signifie que les messages du journal peuvent être vus à l'intérieur des fichiers :
  - /var/log/syslog - pour les dérivés de Debian/Ubuntu
  - /var/log/messages - pour les dérivés de CentOS/RedHat
Dans une section ultérieure, nous aborderons la manière de configurer Kamailio et syslog pour écrire des messages de log
de Kamailio dans un dossier dédié.
